[gcode_macro _NOZZLE_CHANGE]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.cold_swap_hotend %}
        _cold_nozzle
    {% else %}
        _hot_nozzle
    {% endif %}

[gcode_macro _hot_nozzle]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M104 S{S.nozzle_swap_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.nozzle_swap_temp}
    _Retract
    RESPOND TYPE=command MSG="action:prompt_begin Swap"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_button No|_NOZZLE_CHANGE|warning"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _cold_nozzle]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M104 S{S.retract_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.retract_temp}
    _Retract
    M104 S0
    M106 S255
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={S.cold_swap_temp}
    M106 S0
    RESPOND TYPE=command MSG="action:prompt_begin Swap"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _Complete]
gcode:
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1
    M104 S0
    M118 Complete

[gcode_macro _Prompt2]
gcode:
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1

[gcode_macro _Retract]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    G91
    G1 E-{S.retract_distance}
    G92 E0

[gcode_macro _Extrude]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    G91
    G1 E{S.retract_distance}
    G92 E0
