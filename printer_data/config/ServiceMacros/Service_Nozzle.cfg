# -------------------------------------------------------
# Nozzle / toolhead service macros
# -------------------------------------------------------
# Loaded automatically via ServiceSettings.cfg. Do not include directly.

[gcode_macro _NOZZLE_CHANGE]
description: Decide hot vs cold nozzle change based on settings
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set cold_swap_hotend = S.cold_swap_hotend | abs %}

    {% if leds == True %}
        status_heating
    {% endif %}

    {% if cold_swap_hotend == True %}
        _cold_nozzle
    {% else %}
        _hot_nozzle
    {% endif %}


[gcode_macro _hot_nozzle]
description: Hot nozzle swap sequence
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set nozzle_swap_temp = S.nozzle_swap_temp | float %}

    RESPOND TYPE=command MSG=action:prompt_end

    M118 Heating up the nozzle...
    M104 S{nozzle_swap_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={nozzle_swap_temp}

    M118 Retracting filament...
    G4 P1000
    G91
    G92 E0
    _Retract
    G4 P3000

    RESPOND TYPE=command MSG=action:prompt_end
    RESPOND TYPE=command MSG="action:prompt_begin Swap the Nozzle!"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_button Retract|_Retract|info"
    RESPOND TYPE=command MSG="action:prompt_button Extrude|_Extrude|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _cold_nozzle]
description: Cold nozzle swap sequence (e.g. Revo style)
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set retract_temp = S.retract_temp | float %}
    {% set cold_swap_temp = S.cold_swap_temp | float %}

    RESPOND TYPE=command MSG=action:prompt_end

    M118 Heating up the nozzle to retract filament...
    M104 S{retract_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={retract_temp}

    M118 Retracting filament...
    G4 P1000
    G91
    G92 E0
    _Retract
    G4 P5000
    M104 S0

    {% if leds == True %}
        status_cooling
    {% endif %}

    M118 Cooling down for cold nozzle swap. Please wait...
    M106 S255
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={cold_swap_temp}
    M106 S0

    RESPOND TYPE=command MSG="action:prompt_begin Swap the Nozzle!"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _Complete]
description: Finish service and restore previous state
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set cold_swap_hotend = S.cold_swap_hotend | abs %}
    {% set leds = S.leds | abs %}
    {% set autoprobe = S.autoprobe_after_nozzle_change | abs %}

    # Optional: auto-run probe test after nozzle change BEFORE restoring position
    {% if autoprobe == True %}
        M118 Auto probe test enabled – running probe repeatability check...
        _PROBE_TEST
    {% endif %}

    G1 E0
    G90
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1

    {% if cold_swap_hotend == False %}
        M104 S0
    {% endif %}

    RESPOND TYPE=command MSG=action:prompt_end

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    M118 Nozzle Change Complete!


[gcode_macro _Prompt2]
description: Return to last position without nozzle change
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}

    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1
    RESPOND TYPE=command MSG=action:prompt_end

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}


[gcode_macro _Retract]
description: Helper – retract filament by configured distance
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set retract_distance = S.retract_distance | float %}

    G91
    G92 E0
    G1 E-{retract_distance} F300
    G92 E0


[gcode_macro _Extrude]
description: Helper – extrude filament by configured distance
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set retract_distance = S.retract_distance | float %}

    G91
    G92 E0
    G1 E{retract_distance} F300
    G92 E0
