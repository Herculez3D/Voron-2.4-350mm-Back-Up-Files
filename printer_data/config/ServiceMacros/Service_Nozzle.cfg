# ================================
# Service Macros - Nozzle Swaps
# ================================

[gcode_macro _NOZZLE_CHANGE]
description: Entry point for nozzle swap workflow
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}

    RESPOND TYPE=command MSG=action:prompt_end
    M118 Nozzle change requested...

    {% if leds %}
        status_heating
    {% endif %}

    {% if S.cold_swap_hotend %}
        _cold_nozzle
    {% else %}
        _hot_nozzle
    {% endif %}


# ===== HOT NOZZLE SWAP =====

[gcode_macro _hot_nozzle]
description: Hot nozzle swap sequence
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Heating to {S.nozzle_swap_temp}C...
    M104 S{S.nozzle_swap_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.nozzle_swap_temp}

    M118 Retracting filament...
    _Retract
    G4 P2000

    RESPOND TYPE=command MSG="action:prompt_begin Swap Nozzle"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_button Retract|_Retract|info"
    RESPOND TYPE=command MSG="action:prompt_button Extrude|_Extrude|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"


# ===== COLD NOZZLE SWAP =====

[gcode_macro _cold_nozzle]
description: Cold nozzle swap for systems like Revo
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Heating to retract temp {S.retract_temp}C...
    M104 S{S.retract_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S.retract_temp}

    M118 Retracting filament...
    _Retract
    G4 P3000

    M118 Cooling to {S.cold_swap_temp}C...
    M104 S0
    M106 S255
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={S.cold_swap_temp}
    M106 S0

    RESPOND TYPE=command MSG="action:prompt_begin Swap Nozzle"
    RESPOND TYPE=command MSG="action:prompt_text Nozzle swap complete?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_Complete|info"
    RESPOND TYPE=command MSG="action:prompt_show"


# ===== COMPLETE NOZZLE CHANGE =====

[gcode_macro _Complete]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}

    RESPOND TYPE=command MSG=action:prompt_end
    M118 Nozzle swap confirmed.

    {% if not S.cold_swap_hotend %}
        M118 Turning nozzle heater off...
        M104 S0
    {% endif %}

    {% if S.autoprobe_after_nozzle_change %}
        M118 Running auto probe test...
        _PROBE_TEST
    {% endif %}

    {% if leds %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    M118 Returning to Service Menu...
    _SERVICE_MENU


# ===== EXIT SERVICE MODE =====

[gcode_macro _Prompt2]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}

    M118 Restoring previous print position...
    G90
    RESTORE_GCODE_STATE NAME=SERVICE_STATE MOVE=1

    RESPOND TYPE=command MSG=action:prompt_end

    {% if leds %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    M118 Service mode exited.


# ===== FILAMENT MOVEMENT =====

[gcode_macro _Retract]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Retracting {S.retract_distance}mm...
    G91
    G1 E-{S.retract_distance}
    G92 E0

[gcode_macro _Extrude]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    M118 Extruding {S.retract_distance}mm...
    G91
    G1 E{S.retract_distance}
    G92 E0
