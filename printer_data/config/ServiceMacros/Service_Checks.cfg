# -------------------------------------------------------
# Checks / diagnostics (Fan, Wiggle, Heater, Heatbreak, Summary)
# -------------------------------------------------------
# Loaded automatically via ServiceSettings.cfg. Do not include directly.

[gcode_macro _CHECKS_MENU]
description: Submenu for diagnostic checks
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

    RESPOND TYPE=command MSG="action:prompt_begin Toolhead Checks"
    RESPOND TYPE=command MSG="action:prompt_text Select a diagnostic test:"

    # Row 1: core checks
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Fans|_FAN_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button Probe|_PROBE_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button Wiggle|_WIGGLE_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"

    # Row 2: thermal checks
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Heater|_HEATER_TEST|warning"
    RESPOND TYPE=command MSG="action:prompt_button Heatbreak|_HEATBREAK_TEST|warning"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"

    # Row 3: summary & back
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Summary|_SERVICE_SUMMARY|info"
    RESPOND TYPE=command MSG="action:prompt_button Back|Service_Position|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"

    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _RETURN_CHECKS]
description: Return helper – go back to checks menu
gcode:
    _CHECKS_MENU


# Fan test: part cooling + hotend fan
[gcode_macro _FAN_TEST]
description: Test part cooling and hotend fans
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}

    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Fan Test"
    RESPOND TYPE=command MSG="action:prompt_text Testing part cooling fan..."
    RESPOND TYPE=command MSG="action:prompt_show"

    {% if leds == True %}
        status_busy
    {% endif %}

    M118 Testing part cooling fan...
    M106 S0
    G4 P800
    M106 S128
    G4 P1000
    M106 S255
    G4 P1500
    M106 S0

    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Part Cooling Fan"
    RESPOND TYPE=command MSG="action:prompt_text Did the part cooling fan spin?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_FAN_TEST_HOTEND|info"
    RESPOND TYPE=command MSG="action:prompt_button No|_FAN_TEST_FAIL|error"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _FAN_TEST_HOTEND]
description: Continue fan test with hotend fan
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}

    RESPOND TYPE=command MSG="action:prompt_begin Hotend Fan Test"
    RESPOND TYPE=command MSG="action:prompt_text Checking hotend fan (may require temp-controlled fan)..."
    RESPOND TYPE=command MSG="action:prompt_show"

    {% if leds == True %}
        status_heating
    {% endif %}

    M118 Heating to 150C to trigger hotend fan...
    M104 S150
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=145
    G4 P2000
    M104 S0

    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Hotend Fan"
    RESPOND TYPE=command MSG="action:prompt_text Did the hotend fan spin?"
    RESPOND TYPE=command MSG="action:prompt_button Yes|_FAN_TEST_COMPLETE|info"
    RESPOND TYPE=command MSG="action:prompt_button No|_FAN_TEST_FAIL|error"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _FAN_TEST_FAIL]
description: Fan test failure message
gcode:
    M118 Fan Test FAILED — check fan wiring, control, or configuration.
    RESPOND TYPE=command MSG="action:prompt_begin Fan Test Failed"
    RESPOND TYPE=command MSG="action:prompt_text Fan test failed. Check wiring, control, or configuration."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|error"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _FAN_TEST_COMPLETE]
description: Fan test completion message
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}
    M118 Fan Test Complete!
    RESPOND TYPE=command MSG="action:prompt_begin Fan Test Complete"
    RESPOND TYPE=command MSG="action:prompt_text Fan test completed successfully."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"


# Wiggle test: belt / rail looseness diagnostic
[gcode_macro _WIGGLE_TEST]
description: Oscillate toolhead to detect mechanical looseness
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set cycles = params.CYCLES|default(5)|int %}
    {% set travel = params.TRAVEL|default(5)|float %}
    {% set vmax_x = printer.configfile.settings.stepper_x.max_velocity * 0.7 * 60 %}
    {% set vmax_y = printer.configfile.settings.stepper_y.max_velocity * 0.7 * 60 %}
    {% set vmax_z = printer.configfile.settings.stepper_z.max_velocity * 0.7 * 60 %}
    {% set vmax_xy = [vmax_x, vmax_y] | min %}
    {% set vmax = [vmax_x, vmax_y, vmax_z] | min %}

    RESPOND TYPE=command MSG="action:prompt_end"
    _Smart_Homing

    {% set x_mid = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2 %}
    {% set y_mid = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2 %}
    {% set z_mid = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z) / 2 %}

    G90
    G0 X{x_mid} Y{y_mid} Z{z_mid} F{vmax}

    {% if leds == True %}
        status_busy
    {% endif %}

    M118 Starting wiggle test...

    # X-axis wiggle
    {% for i in range(cycles) %}
        G0 X{x_mid + travel} F{vmax_x}
        G0 X{x_mid - travel} F{vmax_x}
    {% endfor %}

    # Y-axis wiggle
    {% for i in range(cycles) %}
        G0 Y{y_mid + travel} F{vmax_y}
        G0 Y{y_mid - travel} F{vmax_y}
    {% endfor %}

    M118 Wiggle test complete! Listen for rattling, knocking, or unusual noises.

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    RESPOND TYPE=command MSG="action:prompt_begin Wiggle Test"
    RESPOND TYPE=command MSG="action:prompt_text Did you hear rattling or looseness?"
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"


# Heater health test
[gcode_macro _HEATER_TEST]
description: Basic nozzle heater health check
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set test_temp = S.nozzle_swap_temp | float %}

    RESPOND TYPE=command MSG="action:prompt_end"

    {% if leds == True %}
        status_heating
    {% endif %}

    M118 Heater Check: heating nozzle to {test_temp}C...
    M104 S{test_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={test_temp - 2}

    M118 Holding temperature briefly to observe stability...
    G4 P15000   ; 15s soak

    M104 S0
    M118 Heater Check complete. If it took unusually long or oscillated, inspect heater, wiring, or run PID calibration.

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    RESPOND TYPE=command MSG="action:prompt_begin Heater Check"
    RESPOND TYPE=command MSG="action:prompt_text Check console log for heater behavior details."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"


# Heatbreak cooling performance check
[gcode_macro _HEATBREAK_TEST]
description: Check hotend cooling / heatbreak performance
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set test_temp = S.retract_temp | float %}

    RESPOND TYPE=command MSG="action:prompt_end"

    {% if leds == True %}
        status_heating
    {% endif %}

    M118 Heatbreak Check: heating to {test_temp}C...
    M104 S{test_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={test_temp - 2}

    M118 Holding with part fan OFF, then ON. Watch temperature behavior.
    M106 S0
    G4 P5000   ; 5s fan off
    M106 S255
    G4 P10000  ; 10s fan on

    M104 S0
    M106 S0

    M118 Heatbreak Check complete. If temperature climbed with fan on or cooled very slowly, inspect heatsink fan and airflow.

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    RESPOND TYPE=command MSG="action:prompt_begin Heatbreak Check"
    RESPOND TYPE=command MSG="action:prompt_text Check console for heatbreak behavior notes."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"


# Simple service summary screen
[gcode_macro _SERVICE_SUMMARY]
description: Show high-level info about available service checks
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"

    M118 Service Summary:
    M118 - Use 'Checks' to run Fans / Probe / Wiggle tests.
    M118 - Use Heater and Heatbreak checks to validate thermal behavior.
    M118 - Enable auto-probe-after-nozzle-change in ServiceSettings.cfg if desired.

    RESPOND TYPE=command MSG="action:prompt_begin Service Summary"
    RESPOND TYPE=command MSG="action:prompt_text Fans: tests part & hotend fans. Probe: repeatability. Wiggle: belts/rails. Heater & Heatbreak: thermal health."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"
