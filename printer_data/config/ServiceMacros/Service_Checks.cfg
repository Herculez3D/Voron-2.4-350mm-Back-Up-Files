# ================================
# Service Macros - Checks / Diagnostics
# ================================

[gcode_macro _CHECKS_MENU]
description: Submenu for diagnostic checks
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Toolhead Checks"
    RESPOND TYPE=command MSG="action:prompt_text Select test:"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Fans|_FAN_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button Probe|_PROBE_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button Wiggle|_WIGGLE_TEST|info"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Heater|_HEATER_TEST|warning"
    RESPOND TYPE=command MSG="action:prompt_button Heatbreak|_HEATBREAK_TEST|warning"
    RESPOND TYPE=command MSG="action:prompt_button Back|_SERVICE_MENU|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _RETURN_CHECKS]
description: Return helper â€“ go back to checks menu
gcode:
    _CHECKS_MENU

[gcode_macro _FAN_TEST]
description: Extended part cooling fan ramp test
gcode:
    M118 Fan test: ramping part cooling fan up and down...
    M106 S0
    G4 P1000
    M118 Fan ~30%
    M106 S80
    G4 P2000
    M118 Fan ~60%
    M106 S160
    G4 P3000
    M118 Fan 100%
    M106 S255
    G4 P3000
    M118 Fan ~60%
    M106 S160
    G4 P2000
    M118 Fan ~30%
    M106 S80
    G4 P1000
    M118 Fan OFF
    M106 S0
    M118 Fan test complete. Confirm visually and by sound.
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Fan Test"
    RESPOND TYPE=command MSG="action:prompt_text Fan ramp test complete."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _WIGGLE_TEST]
description: Oscillate toolhead to detect looseness at max speed/accel
gcode:
    {% set xc = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set yc = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y)/2 %}
    {% set zc = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}
    {% set vmax = printer.configfile.settings.printer.max_velocity|float %}
    {% set amax = printer.configfile.settings.printer.max_accel|float %}
    {% set fmax = vmax * 60 %}
    M118 Wiggle test: using max velocity {vmax} mm/s and accel {amax} mm/s^2...
    SET_VELOCITY_LIMIT VELOCITY={vmax} ACCEL={amax}
    G90
    G0 X{xc} Y{yc} Z{zc}
    ; Set feedrate to max (mm/min) for subsequent moves
    G1 F{fmax}
    {% for i in range(10) %}
        G0 X{xc+5}
        G0 X{xc-5}
    {% endfor %}
    {% for i in range(10) %}
        G0 Y{yc+5}
        G0 Y{yc-5}
    {% endfor %}
    ; Restore default velocity limits
    SET_VELOCITY_LIMIT
    ; Return to service position (front center)
    {% set xs = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set zs = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}
    G90
    G0 X{xs} Y25 Z{zs}
    M118 Wiggle test done. Check for unusual noises or movement.
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Wiggle Test"
    RESPOND TYPE=command MSG="action:prompt_text Wiggle test complete."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _HEATER_TEST]
description: Basic nozzle heater health check
gcode:
    M118 Heater check: heating nozzle to 200C...
    M104 S200
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=195
    M118 Holding temperature at 200C briefly...
    G4 P15000
    M104 S0
    M118 Heater check complete. Review temp graph for stability.
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Heater Test"
    RESPOND TYPE=command MSG="action:prompt_text Heater check done."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _HEATBREAK_TEST]
description: Heatbreak cooling performance check
gcode:
    M118 Heatbreak check: heating to 150C...
    M104 S150
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM=145
    M118 Fan OFF soak...
    M106 S0
    G4 P5000
    M118 Fan ON, watching cooldown behavior...
    M106 S255
    G4 P10000
    M104 S0
    M106 S0
    M118 Heatbreak check complete. If temp did not drop, inspect cooling.
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Heatbreak Test"
    RESPOND TYPE=command MSG="action:prompt_text Heatbreak check done."
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"
