# ================================
# Service Macros - Main Entry
# ================================

[respond]

[gcode_macro Service_Position]
description: Enter service mode and move toolhead to service position
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}
    {% set x = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set z = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}

    _Smart_Homing
    SAVE_GCODE_STATE NAME=SERVICE_STATE
    M118 Entering Service Mode...

    {% if leds %}
        status_busy
    {% endif %}

    G90
    G0 X{x} Y25 Z{z}

    _SERVICE_MENU

[gcode_macro _SERVICE_MENU]
description: Top-level service menu (no movement)
gcode:
    RESPOND TYPE=command MSG="action:prompt_end"
    RESPOND TYPE=command MSG="action:prompt_begin Service Mode"
    RESPOND TYPE=command MSG="action:prompt_text Select operation:"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Nozzle|_NOZZLE_CHANGE|warning"
    RESPOND TYPE=command MSG="action:prompt_button Checks|_CHECKS_MENU|info"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button Return|_Prompt2|info"
    RESPOND TYPE=command MSG="action:prompt_button Exit|RESPOND TYPE=command MSG=action:prompt_end|error"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"

[gcode_macro _Smart_Homing]
description: Home only if not already homed
gcode:
    {% if printer.toolhead.homed_axes == "xyz" %}
        M118 Printer already homed
    {% else %}
        M118 Homing all axes...
        G28
    {% endif %}
