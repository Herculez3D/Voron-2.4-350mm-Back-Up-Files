[gcode_macro _ATTACH_DOCKABLE_PROBE]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {S.attach_probe}
    {% endif %}

[gcode_macro _DETACH_DOCKABLE_PROBE]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {S.detach_probe}
    {% endif %}

[gcode_macro _PROBE_TEST]
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set samples = params.SAMPLES|default(5)|int %}
    {% set vals = [] %}
    _ATTACH_DOCKABLE_PROBE
    {% set xc = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set yc = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y)/2 %}
    {% set zc = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}
    G90
    G0 X{xc} Y{yc} Z15
    {% for i in range(samples) %}
        PROBE
        {% set _ = vals.append(printer.probe.last_z_result) %}
        G91
        G0 Z5
        G90
    {% endfor %}
    _DETACH_DOCKABLE_PROBE
    {% set avg = (vals|sum) / (vals|length) %}
    {% set minv = vals|min %}
    {% set maxv = vals|max %}
    {% set dev = maxv - minv %}
    G90
    G0 X{xc} Y25 Z{zc}
    RESPOND TYPE=command MSG="action:prompt_begin Probe"
    RESPOND TYPE=command MSG="action:prompt_text Î”Z = {dev}"
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|info"
    RESPOND TYPE=command MSG="action:prompt_show"
