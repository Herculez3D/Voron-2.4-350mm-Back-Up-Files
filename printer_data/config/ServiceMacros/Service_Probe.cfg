# ================================
# Service Macros - Probe Handling
# ================================

[gcode_macro _ATTACH_DOCKABLE_PROBE]
description: Attach probe if dockable probe mode is enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.attach_probe|string|length > 0 %}
            M118 Attaching probe...
            {S.attach_probe}
        {% else %}
            M118 WARNING: Dockable probe enabled but attach_probe is empty.
        {% endif %}
    {% endif %}


[gcode_macro _DETACH_DOCKABLE_PROBE]
description: Detach probe if dockable probe mode is enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.detach_probe|string|length > 0 %}
            M118 Detaching probe...
            {S.detach_probe}
        {% else %}
            M118 WARNING: Dockable probe enabled but detach_probe is empty.
        {% endif %}
    {% endif %}


# ======================================
# PROBE REPEATABILITY TEST (PROBE_ACCURACY)
# ======================================

[gcode_macro _PROBE_TEST]
description: Probe repeatability test using PROBE_ACCURACY (console output only)
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}
    {% set samples = S.probe_samples|int %}
    {% set lift = 5 %}
    {% set fx = (S.move_speed_x * 60)|int %}
    {% set fy = (S.move_speed_y * 60)|int %}
    {% set fz = (S.move_speed_z * 60)|int %}

    M118 === Probe Test Start ===
    M118 Samples {samples}

    _ATTACH_DOCKABLE_PROBE

    # Move to center of bed (or machine area)
    {% set xc = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set yc = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y)/2 %}
    {% set zc = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}

    G90
    G1 X{xc} Y{yc} F{fx}
    G1 Z5 F{fz}

    {% if leds %}
        status_busy
    {% endif %}

    # Let Klipper handle probe repeatability and print results
    PROBE_ACCURACY SAMPLES={samples} RETRACT={lift}

    _DETACH_DOCKABLE_PROBE

    M118 === Probe Test End ===

    # Return to service position (front-center)
    {% set sx = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set sy = 25 %}
    {% set sz = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}

    G90
    G1 X{sx} F{fx}
    G1 Y{sy} F{fy}
    G1 Z{sz} F{fz}

    {% if leds %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    _RETURN_CHECKS
