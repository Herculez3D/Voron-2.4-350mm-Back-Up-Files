# ================================
# Service Macros - Probe Tests
# ================================

[gcode_macro _ATTACH_DOCKABLE_PROBE]
description: Attach dockable probe if enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.attach_probe|string|length == 0 %}
            M118 WARNING: dockable_probe is True but 'attach_probe' G-code is empty.
        {% else %}
            M118 Attaching dockable probe...
            {S.attach_probe}
        {% endif %}
    {% endif %}

[gcode_macro _DETACH_DOCKABLE_PROBE]
description: Detach dockable probe if enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.detach_probe|string|length == 0 %}
            M118 WARNING: dockable_probe is True but 'detach_probe' G-code is empty.
        {% else %}
            M118 Detaching dockable probe...
            {S.detach_probe}
        {% endif %}
    {% endif %}

[gcode_macro _PROBE_TEST]
description: Probe repeatability test (console output only)
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds %}
    {% set samples = params.SAMPLES|default(5)|int %}
    {% set vals = [] %}
    {% set lift = 5 %}

    M118 === Probe Test Start ===
    M118 Samples: {samples}

    _ATTACH_DOCKABLE_PROBE

    {% set xc = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x)/2 %}
    {% set yc = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y)/2 %}
    {% set zc = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z)/2 %}

    G90
    G0 X{xc} Y{yc} Z15

    {% if leds %}
        status_busy
    {% endif %}

    {% for i in range(samples) %}
        PROBE
        {% set z = printer.probe.last_z_result %}
        {% set _ = vals.append(z) %}
        M118 Sample {i+1}: Z={z}
        G91
        G0 Z{lift}
        G90
    {% endfor %}

    _DETACH_DOCKABLE_PROBE

    {% set avg = (vals|sum) / (vals|length) %}
    {% set minv = vals|min %}
    {% set maxv = vals|max %}
    {% set dev = maxv - minv %}

    M118 Results: values={vals}
    M118 Avg={avg}  Min={minv}  Max={maxv}  Î”Z={dev}
    M118 === Probe Test End ===

    G90
    G0 X{xc} Y25 Z{zc}

    {% if leds %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    _RETURN_CHECKS
