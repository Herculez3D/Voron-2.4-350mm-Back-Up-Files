# -------------------------------------------------------
# Probe-related service macros (dockable support + repeatability test)
# -------------------------------------------------------
# Loaded automatically via ServiceSettings.cfg. Do not include directly.

[gcode_macro _ATTACH_DOCKABLE_PROBE]
description: Attach dockable probe if enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.attach_probe|length == 0 %}
            {action_raise_error("Dockable probe enabled but 'attach_probe' is empty in ServiceSettings.cfg")}
        {% endif %}
        M118 Attaching dockable probe...
        {S.attach_probe}
    {% endif %}


[gcode_macro _DETACH_DOCKABLE_PROBE]
description: Detach dockable probe if enabled
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% if S.dockable_probe %}
        {% if S.detach_probe|length == 0 %}
            {action_raise_error("Dockable probe enabled but 'detach_probe' is empty in ServiceSettings.cfg")}
        {% endif %}
        M118 Detaching dockable probe...
        {S.detach_probe}
    {% endif %}


[gcode_macro _PROBE_TEST]
description: Probe repeatability test with optional dockable probe
gcode:
    {% set S = printer["gcode_macro Service_settings"] %}
    {% set leds = S.leds | abs %}
    {% set samples = params.SAMPLES|default(5)|int %}
    {% set lift = 5 %}
    {% set Zvals = [] %}
    {% set vmax_x = printer.configfile.settings.stepper_x.max_velocity * 0.7 * 60 %}
    {% set vmax_y = printer.configfile.settings.stepper_y.max_velocity * 0.7 * 60 %}
    {% set vmax_z = printer.configfile.settings.stepper_z.max_velocity * 0.7 * 60 %}
    {% set vmax_xy = [vmax_x, vmax_y] | min %}
    {% set vmax = [vmax_x, vmax_y, vmax_z] | min %}

    RESPOND TYPE=command MSG="action:prompt_end"
    _Smart_Homing

    # Service & probe positions (center of bed, service Z center)
    {% set x_center = (printer.toolhead.axis_minimum.x + printer.toolhead.axis_maximum.x) / 2 %}
    {% set y_center = (printer.toolhead.axis_minimum.y + printer.toolhead.axis_maximum.y) / 2 %}
    {% set z_center = (printer.toolhead.axis_minimum.z + printer.toolhead.axis_maximum.z) / 2 %}

    {% if leds == True %}
        status_busy
    {% endif %}

    # Attach probe if dockable
    _ATTACH_DOCKABLE_PROBE

    M118 Moving to probe test position...

    G90
    G0 X{x_center} Y{y_center} F{vmax_xy}
    G0 Z15 F{vmax_z}

    M118 Starting probe repeatability test...

    # Collect probe samples
    {% for i in range(samples) %}
        PROBE
        {% set z = printer.probe.last_z_result %}
        {% set _ = Zvals.append(z) %}
        G91
        G1 Z{lift} F{vmax_z}
        G90
    {% endfor %}

    # Basic stats
    {% set n = Zvals|length %}
    {% set avg = (Zvals|sum) / n %}
    {% set minv = Zvals|min %}
    {% set maxv = Zvals|max %}
    {% set dev = (maxv - minv) %}

    # Classify result based on deviation range
    {% if dev < 0.01 %}
        {% set status = "PASS" %}
        {% set color = "info" %}
    {% elif dev < 0.03 %}
        {% set status = "WARNING" %}
        {% set color = "warning" %}
    {% else %}
        {% set status = "FAIL" %}
        {% set color = "error" %}
    {% endif %}

    # Detach probe if dockable
    _DETACH_DOCKABLE_PROBE

    # Console report
    M118 ================================
    M118 PROBE REPEATABILITY RESULTS
    M118 Samples: {Zvals}
    M118 Average (Z): {avg}
    M118 Min: {minv}  Max: {maxv}
    M118 Deviation (max-min): {dev}
    M118 Result: {status}
    M118 ================================

    M118 Returning to service position...

    G90
    G0 X{x_center} Y25 Z{z_center} F{vmax}

    {% if leds == True %}
        STOP_LED_EFFECTS
        SET_LED_EFFECT EFFECT=rainbow
    {% endif %}

    RESPOND TYPE=command MSG="action:prompt_begin Probe Test Result"
    RESPOND TYPE=command MSG="action:prompt_text Result: {status}  (Î”Z = {dev})"
    RESPOND TYPE=command MSG="action:prompt_button OK|_RETURN_CHECKS|{color}"
    RESPOND TYPE=command MSG="action:prompt_show"
